<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Access UKB data on Rosalind • ukbkings</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Access UKB data on Rosalind">
<meta property="og:description" content="ukbkings">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ukbkings</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/kcl-ukb-access.html">Access UKB data on Rosalind</a>
    </li>
    <li>
      <a href="../articles/kcl-ukb-setup.html">Setup UKB project on Rosalind</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/kenhanscombe/ukbkings/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Access UKB data on Rosalind</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/kenhanscombe/ukbkings/blob/master/vignettes/kcl-ukb-access.Rmd"><code>vignettes/kcl-ukb-access.Rmd</code></a></small>
      <div class="hidden name"><code>kcl-ukb-access.Rmd</code></div>

    </div>

    
    
<hr>
<p><strong>Note. This document is only useful for UKB-approved KCL reasearchers and their collaborators, with an account on the Rosalind HPC cluster.</strong></p>
<p><br></p>
<p><strong>Important.</strong> The ukbkings package only works on a Rosalind UKB project directory that has been setup to use the package. See vignette(“Setup UKB project on Rosalind”) or <a href="https://kenhanscombe.github.io/ukbkings/">read the article on the package webpage</a>. NB. This step is typically run once, by the person who manages UKB data on Rosalind.</p>
<hr>
<div id="tldr" class="section level3">
<h3 class="hasAnchor">
<a href="#tldr" class="anchor"></a>tldr</h3>
<p>Install the package</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="kw pkg">devtools</span><span class="kw ns">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span>(<span class="st">"kenhanscombe/ukbkings"</span>, <span class="kw">dependencies</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">force</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<p>Write a serialised R dataframe to file for your required fields.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu">bio_phen</span>(
 <span class="kw">project_dir</span> <span class="kw">=</span> <span class="st">"&lt;path_to_project_directory&gt;"</span>,
 <span class="kw">field</span> <span class="kw">=</span> <span class="st">"&lt;path_to_required_fields_file&gt;"</span>,  <span class="co"># one per line, no header</span>
 <span class="kw">out</span> <span class="kw">=</span> <span class="st">"&lt;stem_of_output_file&gt;"</span>  <span class="co"># e.g. "data/ukb" writes "data/ukb.rds"</span>
)</pre></body></html></div>
<p><em><strong>Note</strong>. <code>bio_phen</code> reads a withdrawal file from the project directory and replaces phenotype values for to-be-excluded samples with <code>NA</code>.</em></p>
<p><br></p>
<p>Read the generated dataset into R.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"data/ukb.rds"</span>)</pre></body></html></div>
<p><br></p>
</div>
<div id="preamble" class="section level3">
<h3 class="hasAnchor">
<a href="#preamble" class="anchor"></a>Preamble</h3>
<p>On Rosalind, change to your UKB user directory. If you do not have a UKB user directory, create one first at /scratch/groups/ukbiobank/Edinburgh_Data/usr/<em>&lt;username&gt;</em>. Start an interactive cluster session with sufficient memory to read the UKB data (I think you can get away with less, but I’ve not worked that out yet). Load the default cluster version of R (<code>module avail 2&amp;&gt;1 | grep R</code> currently <code>apps/R/3.6.0</code>) then start R.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># Rosalind shell</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="bu">cd</span> /scratch/groups/ukbiobank/Edinburgh_Data/usr/<span class="op">&lt;</span>username<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="ex">srun</span> -p shared,brc --mem=30G --pty /bin/bash</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="ex">module</span> load apps/R/3.6.0</a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="ex">R</span></a></code></pre></div>
<p><br></p>
</div>
<div id="installation" class="section level3">
<h3 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h3>
<p><em><strong>Note</strong>. All code blocks below are R, unless otherwise specified.</em></p>
<p><br></p>
<p>Install from Github</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="kw pkg">devtools</span><span class="kw ns">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span>(<span class="st">"kenhanscombe/ukbkings"</span>, <span class="kw">dependencies</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">force</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<p>Load libraries. (I like to use tidyverse but it is not necessary, base R is fine)</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ukbkings</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>)</pre></body></html></div>
<p>Check help (press ‘q’ to exit).</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r">?<span class="no">ukbkings</span></pre></body></html></div>
<p><em><strong>Note</strong>. All included data and functionality is described in the package index and also described on the <a href="https://kenhanscombe.github.io/ukbkings/">ukbkings webpage</a> under the <strong>Reference</strong> tab.</em></p>
<p><br></p>
<p>Check help on specific function, e.g.,</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r">?<span class="no">bio_phen</span></pre></body></html></div>
<p>Point to the project directory.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">project_dir</span> <span class="kw">&lt;-</span> <span class="st">"/scratch/datasets/ukbiobank/ukb&lt;project_id&gt;_&lt;ownername&gt;"</span></pre></body></html></div>
<p><br></p>
</div>
<div id="field-subset-file" class="section level3">
<h3 class="hasAnchor">
<a href="#field-subset-file" class="anchor"></a>Field subset file</h3>
<p>You need a file with required fields, one per line, no header.</p>
<p><br></p>
<p>Read the project field-to-name “field finder” file, inspect the variable metadata, and display the number of baskets included.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">f</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ukbkings/man/bio_field.html">bio_field</a></span>(<span class="no">project_dir</span>)

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">f</span>)
<span class="fu">glimpse</span>(<span class="no">f</span>)

<span class="no">f</span> <span class="kw">%&gt;%</span>
<span class="fu">distinct</span>(<span class="no">basket</span>)</pre></body></html></div>
<p>Search for variables required and add their field codes to a file, one per line, no header. You can page through the file.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">f</span> <span class="kw">%&gt;%</span>
<span class="fu">select</span>(<span class="no">name</span>) <span class="kw">%&gt;%</span>
<span class="fu"><a href="https://rdrr.io/r/utils/page.html">page</a></span>(<span class="kw">method</span> <span class="kw">=</span> <span class="st">"print"</span>)</pre></body></html></div>
<p>Or, search <code>name</code> column</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">f</span> <span class="kw">%&gt;%</span>
<span class="fu">select</span>(<span class="no">field</span>, <span class="no">name</span>) <span class="kw">%&gt;%</span>
<span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="fu">str_detect</span>(<span class="no">name</span>, <span class="st">"vegetables"</span>))

<span class="no">f</span> <span class="kw">%&gt;%</span>
<span class="fu">select</span>(<span class="no">field</span>, <span class="no">name</span>) <span class="kw">%&gt;%</span>
<span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="fu">str_detect</span>(<span class="no">name</span>, <span class="st">"ldl|triglycerides"</span>))</pre></body></html></div>
<p>Alternatively, search the <a href="http://biobank.ndph.ox.ac.uk/showcase/">UKB showcase</a> for a variable of interest then filter on the <code>field</code> column in the field-to-name dataframe (useful if multiple instances required). For example, if you search for “cholesterol medication”, the field stem you want is 6177</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">f</span> <span class="kw">%&gt;%</span>
<span class="fu">select</span>(<span class="no">field</span>, <span class="no">name</span>) <span class="kw">%&gt;%</span>
<span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="fu">str_detect</span>(<span class="no">field</span>, <span class="st">"6177"</span>))</pre></body></html></div>
<p><code>bio_field_add</code> is a convenience function for creating the one per line required variables/fields file. By default the function appends fields. Create the field subset file in your UKB user directory /scratch/groups/ukbiobank/Edinburgh_Data/usr/<em>&lt;username&gt;</em>/</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">f</span> <span class="kw">%&gt;%</span>
<span class="fu">select</span>(<span class="no">field</span>, <span class="no">name</span>) <span class="kw">%&gt;%</span>
<span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="fu">str_detect</span>(<span class="no">field</span>, <span class="st">"6177"</span>)) <span class="kw">%&gt;%</span>
<span class="fu"><a href="https://rdrr.io/pkg/ukbkings/man/bio_field_add.html">bio_field_add</a></span>(<span class="st">"small_field_subset.txt"</span>)</pre></body></html></div>
<p>Inspect the field selection file.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/system.html">system</a></span>(<span class="st">"cat small_field_subset.txt"</span>)</pre></body></html></div>
<p><br></p>
</div>
<div id="read-and-write-data" class="section level3">
<h3 class="hasAnchor">
<a href="#read-and-write-data" class="anchor"></a>Read and write data</h3>
<p>Read required fields and save as an rds file in your user directory. Argument <code>out</code> should be a path to your UKB user directory</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/ukbkings/man/bio_phen.html">bio_phen</a></span>(
 <span class="no">project_dir</span>,
 <span class="kw">field</span> <span class="kw">=</span> <span class="st">"small_field_subset.txt"</span>,
 <span class="kw">out</span> <span class="kw">=</span> <span class="st">"small_phenotype_subset"</span>
)</pre></body></html></div>
<p><em><strong>Note</strong>. Dates in the UKB data are recorded in a variety of formats, some of which are non-standard: “character string is not in a standard unambiguous format”, e.g., 2009-01-12T11:28:56. All date variables have been left in character format for the user to convert as needed.</em></p>
<p><br></p>
<p>Check the size of your file and read in your dataset</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/system.html">system</a></span>(<span class="st">"ls -lh small_phenotype_subset.rds"</span>)
<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"small_phenotype_subset.rds"</span>)</pre></body></html></div>
<p>If required, rename columns from the default UKB field names to the descriptive names used in the field-to-name “field finder” <code>name</code> column.</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ukbkings/man/bio_rename.html">bio_rename</a></span>(<span class="no">df</span>, <span class="no">f</span>)</pre></body></html></div>
<p><br></p>
</div>
<div id="categorical-codes" class="section level3">
<h3 class="hasAnchor">
<a href="#categorical-codes" class="anchor"></a>Categorical codes</h3>
<p>Categorical field codings are included in the field finder</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">f</span> <span class="kw">%&gt;%</span>
 <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">field</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">df</span>)) <span class="kw">%&gt;%</span>
 <span class="fu">select</span>(<span class="no">field</span>, <span class="no">categorical_coding</span>)</pre></body></html></div>
<p>Retrieve numerical “Value” and and associated “Meaning” for each categorical code.</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="no">cx</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ukbkings/man/bio_code.html">bio_code</a></span>(<span class="no">project_dir</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">cx</span>)</pre></body></html></div>
<p>Look up a particular coding</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="no">cx</span> <span class="kw">%&gt;%</span>
 <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">Coding</span> <span class="kw">==</span> <span class="fl">502</span>)</pre></body></html></div>
<p><br></p>
</div>
<div id="gp-data" class="section level3">
<h3 class="hasAnchor">
<a href="#gp-data" class="anchor"></a>GP data</h3>
<p>If your project has access to primary care data, retrieve the clinical, registrations, scripts datasets with <code>bio_gp</code> e.g.</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">px</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ukbkings/man/bio_gp.html">bio_gp</a></span>(<span class="no">project_dir</span>, <span class="st">"scripts"</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">px</span>)</pre></body></html></div>
<p><br></p>
</div>
<div id="covid-19-data" class="section level3">
<h3 class="hasAnchor">
<a href="#covid-19-data" class="anchor"></a>COVID-19 data</h3>
<p>If your project has access to COVID-19 data, retrieve the results with <code>bio_covid</code></p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="no">covid</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ukbkings/man/bio_covid.html">bio_covid</a></span>(<span class="no">project_dir</span>, <span class="st">"results"</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">covid</span>)</pre></body></html></div>
<p>Descriptive meanings of the numerical values used to encode the categorical variables can be retrieved with <code>data = codes</code></p>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="no">covid_codes</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ukbkings/man/bio_covid.html">bio_covid</a></span>(<span class="no">project_dir</span>, <span class="st">"codes"</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">covid_code</span>)</pre></body></html></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Ken Hanscombe.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
